# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [main]

  workflow_dispatch:

# A wlow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  create-build-id:
    runs-on: ubuntu-latest
    steps:
      - name: 'Set build id'
        id: build_id
        run: echo "::set-output name=id::$(date +%s)"
    outputs:
      build_id: ${{ steps.build_id.outputs.id }}


  build-api:
    runs-on: ubuntu-latest
    needs: create-build-id

    env:
      BUILD_ID: ${{ needs.create-build-id.outputs.build_id }}

    steps:
      - uses: actions/checkout@v2
      - name: docker login
        env:
          DOCKER_USER: ${{ secrets.DOCKER_USER }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          BUILD_ID: ${{ steps.build_id.outputs.id }}
        run: |
          docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
        
      - name: Build docker image
        run: cd lib/api && docker build . --tag ${{ secrets.DOCKER_USER }}/sema:api-${{ github.sha }}-$BUILD_ID

      - name: Docker push
        run: docker push ${{ secrets.DOCKER_USER }}/sema:api-${{ github.sha }}-$BUILD_ID

  build-client:
    runs-on: ubuntu-latest
    needs: create-build-id

    env:
      BUILD_ID: ${{ needs.create-build-id.outputs.build_id }}

    steps:
      - uses: actions/checkout@v2
      - name: docker login
        env:
          DOCKER_USER: ${{ secrets.DOCKER_USER }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
        
      - name: Build docker image
        run: cd lib/client && docker build --build-arg SERVER_HOSTNAME=${{ secrets.SERVER_HOSTNAME }} . --tag ${{ secrets.DOCKER_USER }}/sema:client-${{ github.sha }}-$BUILD_ID

      - name: Docker push
        run: docker push ${{ secrets.DOCKER_USER }}/sema:client-${{ github.sha }}-$BUILD_ID

  build-report-engine:
    runs-on: ubuntu-latest
    needs: create-build-id

    env:
      BUILD_ID: ${{ needs.create-build-id.outputs.build_id }}

    steps:
      - uses: actions/checkout@v2
      - name: docker login
        env:
          DOCKER_USER: ${{ secrets.DOCKER_USER }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
        
      - name: Build docker image
        run: cd lib/report-engine && docker build . --tag ${{ secrets.DOCKER_USER }}/sema:report-engine-${{ github.sha }}-$BUILD_ID

      - name: Docker push
        run: docker push ${{ secrets.DOCKER_USER }}/sema:report-engine-${{ github.sha }}-$BUILD_ID
      