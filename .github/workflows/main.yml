# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [main]

  workflow_dispatch:

# A wlow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  create-build-id:
    runs-on: ubuntu-latest
    steps:
      - name: 'Set build id'
        id: build_id
        run: echo "::set-output name=id::$(date +%s)"
    outputs:
      build_id: ${{ steps.build_id.outputs.id }}


  build-api:
    runs-on: ubuntu-latest
    needs: create-build-id

    env:
      BUILD_ID: ${{ needs.create-build-id.outputs.build_id }}

    steps:
      - uses: actions/checkout@v2
      - name: docker login
        env:
          DOCKER_USER: ${{ secrets.DOCKER_USER }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          BUILD_ID: ${{ steps.build_id.outputs.id }}
        run: |
          docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
        
      - name: Build docker image
        run: cd lib/api && docker build . --tag ${{ secrets.DOCKER_USER }}/sema:api-${{ github.sha }}-$BUILD_ID

      - name: Docker push
        run: docker push ${{ secrets.DOCKER_USER }}/sema:api-${{ github.sha }}-$BUILD_ID

  build-client:
    runs-on: ubuntu-latest
    needs: create-build-id

    env:
      BUILD_ID: ${{ needs.create-build-id.outputs.build_id }}

    steps:
      - uses: actions/checkout@v2
      - name: docker login
        env:
          DOCKER_USER: ${{ secrets.DOCKER_USER }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
        
      - name: Build docker image
        run: |
          cd lib/client && \
          docker build \
            --build-arg SERVER_HOSTNAME=${{ secrets.SERVER_HOSTNAME }} \
            --build-arg NEXT_PUBLIC_APP_URL=${{ secrets.NEXT_PUBLIC_APP_URL }} \
            --build-arg NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }} \
            --tag ${{ secrets.DOCKER_USER }}/sema:client-${{ github.sha }}-$BUILD_ID \
            .

      - name: Docker push
        run: docker push ${{ secrets.DOCKER_USER }}/sema:client-${{ github.sha }}-$BUILD_ID

  build-report-engine:
    runs-on: ubuntu-latest
    needs: create-build-id

    env:
      BUILD_ID: ${{ needs.create-build-id.outputs.build_id }}

    steps:
      - uses: actions/checkout@v2
      - name: docker login
        env:
          DOCKER_USER: ${{ secrets.DOCKER_USER }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
        
      - name: Build docker image
        run: cd lib/report-engine && docker build . --tag ${{ secrets.DOCKER_USER }}/sema:report-engine-${{ github.sha }}-$BUILD_ID

      - name: Docker push
        run: docker push ${{ secrets.DOCKER_USER }}/sema:report-engine-${{ github.sha }}-$BUILD_ID


  deploy-on-kubernetes:
    runs-on: ubuntu-latest
    needs: [create-build-id, build-api, build-client, build-report-engine]

    env:
      BUILD_ID: ${{ needs.create-build-id.outputs.build_id }}

    steps:
      - uses: actions/checkout@v2

      - name: Prep helm chart
        run: |
          echo '{client.image.tag: client-${{ github.sha }}-${{ env.BUILD_ID }}, api.image.tag: api-${{ github.sha }}-${{ env.BUILD_ID }}, report-engine.image.tag: report-engine-${{ github.sha }}-${{ env.BUILD_ID }}}' > values.yaml

      - name: 'Deploy'
        uses: WyriHaximus/github-action-helm3@v2
        with:
          exec: helm upgrade --install app ci/app --values=values.yaml -n prod
          kubeconfig: '${{ secrets.KUBECONFIG }}'

      # - name: 'Deploy'
      #   uses: 'deliverybot/helm@v1'
      #   with:
      #     chart: ci/app
      #     release: app
      #     namespace: prod
      #     values: |
      #       api:
      #         image:
      #           tag: "api-${{ github.sha }}-$BUILD_ID"
      #   env: 
      #     KUBECONFIG_FILE: ${{ secrets.KUBECONFIG }}
      